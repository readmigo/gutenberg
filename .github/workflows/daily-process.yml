name: Daily Process

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      max_books:
        description: 'Maximum books to process'
        required: false
        default: '10'

jobs:
  process:
    name: Process Books
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - name: Trigger batch processing on Droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: readmigo
          key: ${{ secrets.DROPLET_SSH_KEY }}
          command_timeout: 330m
          script: |
            cd /home/readmigo/projects/gutenberg && git checkout -- . && git pull --ff-only
            cd scripts && pnpm install --no-frozen-lockfile 2>/dev/null || true
            npx ts-node pg-batch.ts --max-books=${{ github.event.inputs.max_books || '10' }} 2>&1 | tee -a /tmp/pg-batch-$(date +%Y%m%d).log
